#!/bin/bash

# Script to run unit test for the project in a python virtual environment.
# This script will install python3, python3-venv and redis, if not already installed.
# This script will start a redis server with default settings and shut it down after testing.

sudo apt-get -y install python3 python3-venv redis
if [ $? -ne 0 ]; then
    echo "Failed to install dependencies. Please resolve and try again."
fi

python3 -m venv .venv
if [ $? -ne 0 ]; then
    echo "Failed to create python virtual environment. Please resolve and try again."
fi

source .venv/bin/activate
if [ $? -ne 0 ]; then
    echo "Failed to activate python virtual environment. Please resolve and try again."
fi

pip install -r requirements.txt
if [ $? -ne 0 ]; then
    echo "Failed to install python requirements. Please resolve and try again."
fi

/bin/redis-server &
if [ $? -ne 0 ]; then
    echo "Failed to start local redis server for testing. Please resolve and try again."
fi

python3 test.py
if [ $? -ne 0 ]; then
    echo "Failed to run flask app. Please resolve and try again."
fi

/etc/init.d/redis-server stop
if [ $? -ne 0 ]; then
    echo "Failed to stop redis server."
fi

deactivate
if [ $? -ne 0 ]; then
    echo "Failed to deactivate python virtual environment."
fi

echo ""
echo "This script installed the dependencies: python3 python3-venv redis, if they were not already present."
echo "If you wish to remove these, please run the following command:"
echo "\"sudo apt -y remove python3 python3-venv redis\""
