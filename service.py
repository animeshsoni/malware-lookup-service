from flask import Flask, jsonify
from flask_httpauth import HTTPBasicAuth
import sqlite3


service = Flask(__name__)
auth = HTTPBasicAuth()

#Add default user and password. TODO: Hash password instead of storing in plain text.
#User list can be moved to a db if we have use case for multiple users.
#In a prod service, we should use token based auth. 
users = {
    "default": "someComplexPassword"
}

@auth.get_password
def get_password(username):
    if username in users:
        return users.get(username)
    return None

@auth.error_handler
def unauthorized():
    return jsonify({'error': 'Unauthorized'})

#Open a connection to DB. (Creates one if it doesn't exist)
dbCon = sqlite3.connect("malwareList.db")
dbCursor = dbCon.cursor()
#Check if malwareUrls table exists
dbResult = dbCursor.execute("SELECT name FROM sqlite_master WHERE name='malwareUrls'")
if dbResult.fetchone() == None:
    #Create table if it doesn't exist
    dbCursor.execute("CREATE TABLE malwareUrls(url)")
    # Generate fake list of malwares to experiment with.
    for i in range(500):
        dbCursor.execute("INSERT INTO malwareUrls VALUES ('malware" + str(i) + "')")
        dbCon.commit()
dbCon.close()

# Home screen for the service. TODO: Add link to instructions or remove this function if not needed.
@service.route("/")
@auth.login_required
def home():
    return "Malware URL lookup service!"

# Function to serve the queries at GET /v1/urlinfo/{resource_url_with_query_string}
@service.route('/v1/urlinfo/<resource_url_with_query_string>',methods=['GET'])
@auth.login_required
def isMalware(resource_url_with_query_string):
    #Assume safe by default, unless found in malware DB.
    retVal = jsonify({'response': 'safe'})
    dbCon = sqlite3.connect("malwareList.db")
    dbCursor = dbCon.cursor()
    dbResult = dbCursor.execute("SELECT name FROM sqlite_master WHERE name='malwareUrls'")
    if dbResult.fetchone() == None:
        #Table doesn't exist, something is wrong. TODO: Change this response if needed. Assuming safe for now.
        return retVal
    dbResult = dbCursor.execute("SELECT url FROM malwareUrls WHERE url='" + resource_url_with_query_string + "'")
    if dbResult.fetchone() != None:
        #Found in malware DB
        retVal = jsonify({'response': 'unsafe'})
    dbCon.close()
    return retVal

#Function to add new URLs to malware DB. Not a requirement for mvp. Implement later
# @service.route('/v1/urlinfo',methods=['PUT'])
# def addMalware():
#   return ""

# Start the service. Currently hosted on localhost:5000. TODO: Change the default and host it on web if required.
if __name__ == "__main__":
    service.run()