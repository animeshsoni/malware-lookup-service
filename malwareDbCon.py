import json
import redis

class MalwareDbCon:
    def __init__(self, host, port, key) -> None:
        self.host = host
        self.port = port
        self.key = key
        self.dbCon = None
        try:
            #Open a connection to Redis.
            self.dbCon = redis.Redis(host=self.host, port=self.port, password=self.key, retry=True)
        except redis.RedisError as error:
            raise Exception("Unable to connect to redis server. Error: " + str(error))
    
    def isMalware(self, url) -> json:
        retVal = {'response': 'safe'}
        try:
            result = self.dbCon.get(url)
        except redis.RedisError as error:
            print('Redis error: ' + str(error))
            return {'error': 'Internal database error'}
        finally:
            if result is not None:
                #url exists in db
                retVal = {'response': 'unsafe'}
        return retVal

    def addMalware(self, url) -> json:
        try:
            result = self.dbCon.set(url, '', nx=True)
        except redis.RedisError as error:
            print('Redis error: ' + str(error))
            return {'error': 'Internal database error'}
        return {'response': 'success'}
