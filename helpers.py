from urllib.parse import urlparse
import yaml, os, logging


logger = logging.getLogger(__name__)
logging.basicConfig(format='%(asctime)s %(message)s', datefmt='%m/%d/%Y %I:%M:%S %p')

# Parse url to return only top level and second level domain.
# Ex: https://www.sample.malware.com/path/query will be parsed to malware.com
def getDomain(resource_url) -> str:
    
    # HACK to handle Azure bug. More than one slash in query is replaced with a single slash.
    # Also mentioned in this thread https://github.com/Azure/Azure-Functions/issues/1042 
    if resource_url[:7] == 'https:/' and resource_url[7] != '/':
        resource_url = resource_url[:7] + '/' + resource_url[7:]
    if resource_url[:6] == 'http:/' and resource_url[6] != '/':
        resource_url = resource_url[:6] + '/' + resource_url[6:]
    # End Hack
    
    hostname = urlparse(resource_url).hostname
    if not hostname:
        logger.warning("Invalid url format. resource_url='" + resource_url + "'.")
        return ''
    return'.'.join(hostname.split('.')[-2:])

#Helper function to read yaml config file.
def readYaml(file_path) -> any:
    with open(file_path, 'r') as f:
        return yaml.safe_load(f)

#Helper function to validate and parse the config file
def parseConfig(file_name) -> any:
    config = readYaml(os.path.join(os.getcwd(), file_name))
    #Validate if all the required fields are present in config file
    if not 'REDIS' in config:
        raise Exception("Invalid configuration: Field 'REDIS' missing in config.yaml")
    if not 'hostname' in config['REDIS']:
        raise Exception("Invalid configuration: Field 'hostname' missing from 'REDIS' in config.yaml")
    if not 'port' in config['REDIS']:
        raise Exception("Invalid configuration: Field 'port' missing from 'REDIS' in config.yaml")
    if not 'key' in config['REDIS']:
        raise Exception("Invalid configuration: Field \'key\' missing from \'REDIS\' in config.yaml")
    if not 'USERS' in config:
        raise Exception("Invalid configuration: Field \'USERS\' missing in config.yaml")
    return config